{% extends 'students/base.html' %}

{% block title %}加分项目列表 - 保研加分小助手{% endblock %}

{% block content %}
<!-- 添加必要的JavaScript库 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    .table-hover tbody tr:hover {
        background-color: #e9ecef;
    }
    .btn-action {
        margin: 0 2px;
    }
    .pagination {
        margin-top: 1rem;
    }
    .badge {
        font-size: 0.875rem;
        padding: 0.5em 0.75em;
    }
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
    }
</style>

<div class="row">
    <div class="col-md-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">首页</a></li>
                <li class="breadcrumb-item active" aria-current="page">加分项目列表</li>
            </ol>
        </nav>
    </div>
</div>

        <div class="row">
            <!-- 加分项目列表 -->
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-white border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">加分项目列表</h5>
                            {% if user.is_staff %}
                                <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addScoreItemModal">
                                <i class="fa fa-plus mr-1"></i>添加项目
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>项目名称</th>
                                        <th>类别</th>
                                        <th>级别</th>
                                        <th>对应分值</th>
                                        <th>项目说明</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in score_items %}
                                        <tr>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.category }}</td>
                                            <td>{{ item.level }}</td>
                                            <td>{{ item.score_value }}</td>
                                            <td>{{ item.description|truncatewords:10 }}</td>
                                            <td>{{ item.created_at }}</td>
                                            <td>
                                                <a href="{{ item.detail_url }}" class="btn btn-sm btn-info btn-action" title="查看详情">
                                                    <i class="fa fa-eye"></i>
                                                </a>
                                                {% if user.is_staff and item.edit_url %}
                                                    <a href="{{ item.edit_url }}" class="btn btn-sm btn-warning btn-action" title="编辑">
                                                        <i class="fa fa-pencil"></i>
                                                    </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">暂无加分项目</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        {% if is_paginated %}
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" aria-label="Previous">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-hidden="true">&laquo;</span>
                                        </li>
                                    {% endif %}

                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item"><a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a></li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled">
                                            <span class="page-link" aria-hidden="true">&raquo;</span>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    <!-- 页脚已移至base.html模板 -->

    <!-- 添加提示消息容器 -->
    {% if messages %}
    <div class="messages-container" style="position: fixed; top: 20px; right: 20px; z-index: 1050;">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="关闭">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 添加项目模态框 -->
    <div class="modal fade" id="addScoreItemModal" tabindex="-1" aria-labelledby="addScoreItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addScoreItemModalLabel">添加加分项目</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="关闭">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addScoreItemForm" method="post" action="{% url 'students:scoreitem-list' %}">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="name" class="form-label">项目名称</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="category" class="form-label">类别</label>
                            <select class="form-control" id="category" name="category" required>
                                <option value="" selected disabled>请选择类别</option>
                                <option value="competition">竞赛</option>
                                <option value="thesis">论文</option>
                                <option value="patent">专利</option>
                                <option value="scholarship">奖学金</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="level" class="form-label">级别</label>
                            <select class="form-control" id="level" name="level" required>
                                <option value="" selected disabled>请选择级别</option>
                                <option value="校级">校级</option>
                                <option value="市级">市级</option>
                                <option value="省级">省级</option>
                                <option value="国家级">国家级</option>
                                <option value="国际级">国际级</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="score" class="form-label">对应分值</label>
                            <input type="number" class="form-control" id="score" name="score" step="0.1" min="0" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">项目说明</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary" form="addScoreItemForm">确认添加</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 获取CSRF令牌
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // 检查是否是我们需要的cookie
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 表单验证和提交
        $(document).ready(function() {
            console.log('页面加载完成，初始化表单处理...');
            
            // 检查jQuery是否加载
            if (typeof jQuery === 'undefined') {
                console.error('jQuery未加载');
                alert('系统错误：jQuery库未加载，请刷新页面重试');
                return;
            }
            
            // 检查Bootstrap是否加载
            if (typeof $().modal === 'undefined') {
                console.error('Bootstrap未加载');
                alert('系统警告：Bootstrap库未完全加载，某些功能可能受限');
            }
            
            // 获取DOM元素
            const addScoreItemModal = $('#addScoreItemModal');
            const addScoreItemForm = $('#addScoreItemForm');
            const addButton = $('button[data-toggle="modal"]');
            
            console.log('模态框元素:', addScoreItemModal.length > 0 ? '找到' : '未找到');
            console.log('表单元素:', addScoreItemForm.length > 0 ? '找到' : '未找到');
            console.log('添加按钮:', addButton.length > 0 ? '找到' : '未找到');
            
            // 模态框显示事件
            addScoreItemModal.on('show.bs.modal', function() {
                console.log('模态框显示事件触发');
                // 清空表单
                addScoreItemForm[0].reset();
            });
            
            // 表单提交
            addScoreItemForm.on('submit', function(e) {
                e.preventDefault();
                console.log('表单提交事件触发');
                
                // 验证所有必填字段
                const name = $('#name').val().trim();
                const category = $('#category').val();
                const level = $('#level').val().trim();
                const score = $('#score').val().trim();
                const description = $('#description').val().trim();
                
                console.log('表单数据:', { name, category, level, score, description });
                
                // 检查必填字段
                if (!name) {
                    alert('请输入项目名称');
                    $('#name').focus();
                    return;
                }
                
                if (!category) {
                    alert('请选择类别');
                    $('#category').focus();
                    return;
                }
                
                if (!level) {
                    alert('请选择级别');
                    $('#level').focus();
                    return;
                }
                
                // 验证分值是否为非负数
                if (!score || isNaN(score) || parseFloat(score) < 0) {
                    alert('请输入有效的非负分值');
                    $('#score').focus();
                    return;
                }
                
                // 获取提交按钮 - 注意按钮在模态框页脚中，不在表单内部
                const submitBtn = $('button[type="submit"][form="addScoreItemForm"]');
                const originalBtnText = submitBtn.html();
                
                // 禁用按钮并显示加载状态
                submitBtn.prop('disabled', true);
                submitBtn.html('<i class="fa fa-spinner fa-spin"></i> 提交中...');
                
                // 获取CSRF令牌
                const csrfToken = getCookie('csrftoken');
                
                // 构建表单数据
                const formData = {
                    name: name,
                    category: category,
                    level: level,
                    score: score,
                    description: description,
                    csrfmiddlewaretoken: csrfToken
                };
                
                console.log('准备发送的数据:', formData);
                console.log('CSRF令牌:', formData.csrfmiddlewaretoken);
                
                // 发送Ajax请求
                $.ajax({
                    url: $(this).attr('action'),
                    type: 'POST',
                    data: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': csrfToken
                    },
                    dataType: 'json',
                    success: function(response) {
                        console.log('项目添加成功:', response);
                        // 显示成功消息
                        alert(response.message || '项目添加成功');
                        
                        // 隐藏模态框
                        addScoreItemModal.modal('hide');
                        
                        // 重新加载页面更新列表
                        setTimeout(function() {
                            location.reload();
                        }, 500);
                    },
                    error: function(xhr, status, error) {
                        console.error('项目添加失败:', xhr, status, error);
                        console.log('响应状态:', xhr.status);
                        console.log('响应文本:', xhr.responseText);
                        
                        // 显示错误消息
                        let errorMessage = '项目添加失败，请稍后重试';
                        try {
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else if (xhr.responseText) {
                                errorMessage = '服务器错误: ' + xhr.responseText.substring(0, 100) + '...';
                            }
                        } catch (e) {
                            console.error('解析错误响应失败:', e);
                        }
                        alert('错误: ' + errorMessage);
                    },
                    complete: function() {
                        console.log('Ajax请求完成');
                        // 恢复按钮状态
                        submitBtn.prop('disabled', false);
                        submitBtn.html(originalBtnText);
                    }
                });
            });
            
            // 为消息框添加自动隐藏功能
            setTimeout(function() {
                const messages = document.querySelectorAll('.alert');
                messages.forEach(function(message) {
                    setTimeout(function() {
                        if (typeof $ !== 'undefined') {
                            $(message).alert('close');
                        }
                    }, 3000);
                });
            }, 500);
        });
    </script>

{% endblock %}