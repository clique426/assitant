{% extends 'students/base.html' %}

{% block title %}个人信息中心 - 保研加分小助手{% endblock %}

{% block content %}
<style>
    .info-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 500;
        color: #495057;
    }
    .info-value {
        color: #212529;
    }
    .nav-link {
        cursor: pointer;
    }
    .nav-link.active {
        font-weight: 600;
    }
    .tab-content {
        padding: 1.5rem 0;
    }
    .badge-status {
        padding: 0.35em 0.65em;
        font-size: 0.75em;
        font-weight: 700;
        border-radius: 0.375rem;
    }
    .badge-status.pending {
        background-color: #ffc107;
        color: #212529;
    }
    .badge-status.approved {
        background-color: #198754;
        color: white;
    }
    .badge-status.rejected {
        background-color: #dc3545;
        color: white;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    .btn-edit {
        float: right;
    }
    .form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .alert {
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }
</style>

{% if user.is_authenticated %}
    <!-- 显示成功消息 -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success alert-dismissible fade show">
                <i class="fa fa-check-circle mr-2"></i>{{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- 显示错误消息 -->
    {% if errors %}
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fa fa-exclamation-circle mr-2"></i>修改失败，请检查以下问题：
            <ul class="mt-2">
                {% for field, error in errors.items %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}
    
    <!-- 个人档案内容 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">基本信息</h5>
            {% if not is_editing %}
                <button class="btn btn-sm btn-primary btn-edit" id="edit-btn">
                    <i class="fa fa-pencil"></i> 修改信息
                </button>
            {% endif %}
        </div>
        <div class="card-body">

            
            <!-- 查看模式 -->
            <div id="view-mode" {% if is_editing %}style="display: none;"{% endif %}>
                <div class="row info-item">
                    <div class="col-md-3 info-label">用户名:</div>
                    <div class="col-md-9 info-value">{{ user.username }}</div>
                </div>
                <!-- 基本信息 -->
                <div class="row info-item">
                    <div class="col-md-3 info-label">姓名:</div>
                    <div class="col-md-9 info-value">{{ student_profile.full_name|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">学号:</div>
                    <div class="col-md-9 info-value">{{ student_profile.student_id|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">年级:</div>
                    <div class="col-md-9 info-value">{{ student_profile.grade|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">专业:</div>
                    <div class="col-md-9 info-value">{{ student_profile.major|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">班级:</div>
                    <div class="col-md-9 info-value">{{ student_profile.class_name|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">邮箱:</div>
                    <div class="col-md-9 info-value">{{ student_profile.email|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">手机号:</div>
                    <div class="col-md-9 info-value">{{ student_profile.phone|default:'未设置' }}</div>
                </div>
                <div class="row info-item">
                    <div class="col-md-3 info-label">总加分:</div>
                    <div class="col-md-9 info-value">{{ student_profile.total_score|default:0 }}</div>
                </div>
            </div>
            
            <!-- 编辑模式 -->
            <div id="edit-mode" {% if not is_editing %}style="display: none;"{% endif %}>
                <form method="post" action="{% url 'students:personal-info' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                                <input type="text" id="username" name="username" class="form-control" 
                                       value="{{ user.username }}" placeholder="请输入用户名" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="student_id" class="form-label">学号 <span class="text-danger">*</span></label>
                                <input type="text" id="student_id" name="student_id" class="form-control" 
                                       value="{{ student_profile.student_id|default:'' }}" placeholder="请输入学号" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="full_name" class="form-label">姓名 <span class="text-danger">*</span></label>
                                <input type="text" id="full_name" name="full_name" class="form-control" 
                                       value="{{ student_profile.full_name|default:'' }}" placeholder="请输入真实姓名" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="grade" class="form-label">年级</label>
                                <input type="text" id="grade" name="grade" class="form-control" 
                                       value="{{ student_profile.grade|default:'' }}" placeholder="如：2022级">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="major" class="form-label">专业</label>
                                <input type="text" id="major" name="major" class="form-control" 
                                       value="{{ student_profile.major|default:'' }}" placeholder="请输入专业名称">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="class_name" class="form-label">班级</label>
                                <input type="text" id="class_name" name="class_name" class="form-control" 
                                       value="{{ student_profile.class_name|default:'' }}" placeholder="如：计算机1班">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="email" class="form-label">邮箱</label>
                                <input type="email" id="email" name="email" class="form-control" 
                                       value="{{ student_profile.email|default:'' }}" placeholder="请输入邮箱地址">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="phone" class="form-label">手机号</label>
                                <input type="tel" id="phone" name="phone" class="form-control" 
                                       value="{{ student_profile.phone|default:'' }}" placeholder="请输入手机号码">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">注意：</label>
                        <p class="text-muted text-sm">学号不可修改，如有错误请联系管理员。</p>
                    </div>
                    
                    <div class="form-group text-right">
                        <button type="button" class="btn btn-secondary mr-2" id="cancel-btn">
                            <i class="fa fa-times"></i> 取消
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i> 保存修改
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 使用DOMContentLoaded确保DOM完全加载后再绑定事件
        document.addEventListener('DOMContentLoaded', function() {
            // 切换到编辑模式
            window.switchToEditMode = function() {
                document.getElementById('view-mode').style.display = 'none';
                document.getElementById('edit-mode').style.display = 'block';
            };
            
            // 切换到查看模式
            window.switchToViewMode = function() {
                document.getElementById('view-mode').style.display = 'block';
                document.getElementById('edit-mode').style.display = 'none';
            };
            
            // 绑定按钮事件
            const editBtn = document.getElementById('edit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            
            if (editBtn) {
                editBtn.addEventListener('click', window.switchToEditMode);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', window.switchToViewMode);
            }
        });
    </script>

{% else %}
    <div class="card">
        <div class="card-body text-center">
            <h5>请先登录</h5>
            <p class="text-muted mt-2">登录后查看个人信息</p>
            <a href="{{ login_url }}" class="btn btn-primary mt-3">前往登录</a>
        </div>
    </div>
{% endif %}

{% endblock %}